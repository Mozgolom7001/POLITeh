////////////////////////////////////////////////////////////////////////////////
// ПЕРЕМЕННЫЕ МОДУЛЯ

Перем мВосстановленыЗначения;
Перем мВыбраннаяСтратегия;
Перем мНастройкаПериода;

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

Процедура УстановитьНачальныеЗначения()
	
	Для каждого Стратегия из мМассивСтратегии Цикл
		
		НоваяСтратегия = СтратегииРасчета.Добавить();
		НоваяСтратегия.ВидСтратегии = Стратегия.ВидСтратегии;
		НоваяСтратегия.НаименованиеСтратегии = Стратегия.Представление;
		НоваяСтратегия.Процент = 100;
		НоваяСтратегия.Использование = Ложь;
		УстановитьИдентификаторСтроки(НоваяСтратегия, СтратегииРасчета.ВыгрузитьКолонку("ИдентификаторСтроки"));
		
	КонецЦикла;
	
КонецПроцедуры // УстановитьНачальныеЗначения()

Процедура ОбновитьСостоянияДокументов()
	
	Индекс = 0;
	
	Пока Индекс < СформированныеДокументы.Количество() Цикл
		
		СтрокаТаблицы = СформированныеДокументы[Индекс];
		
		Попытка
			
			Если СтрокаТаблицы.Документ.ПолучитьОбъект() = Неопределено Тогда
				
				СформированныеДокументы.Удалить(СтрокаТаблицы);
				Продолжить;
				
			КонецЕсли;
			
		Исключение
			
			СформированныеДокументы.Удалить(СтрокаТаблицы);
			Продолжить;
			
		КонецПопытки;
		
		Если СтрокаТаблицы.Документ.ПометкаУдаления Тогда
			
			СтрокаТаблицы.ПометкаУдаления  = Истина;
			СтрокаТаблицы.ДокументПроведен = Ложь;
			
		ИначеЕсли СтрокаТаблицы.Документ.Проведен Тогда
			
			СтрокаТаблицы.ПометкаУдаления  = Ложь;
			СтрокаТаблицы.ДокументПроведен = Истина;
			
		Иначе
			
			СтрокаТаблицы.ПометкаУдаления  = Ложь;
			СтрокаТаблицы.ДокументПроведен = Ложь;
			
		КонецЕсли; 
		
		Индекс = Индекс + 1;
	
	КонецЦикла; 

КонецПроцедуры // ОбновитьСостоянияДокументов()

Процедура УстановитьЭкспортныеПеременные()

	мСформированныеДокументы = СформированныеДокументы;

КонецПроцедуры // УстановитьЭкспортныеПеременные()

Процедура УстановитьПредставлениеРежимСложенияОбъединения()
	
	Результат = "";
	
	Результат = Результат + ?(мРежимСложениеОбъединениеСУчетомЗаказов = Истина, ?(ПустаяСтрока(Результат),"", ", ") + "Заказ", "");
	Результат = Результат + ?(мРежимСложениеОбъединениеСУчетомПодразделений = Истина, ?(ПустаяСтрока(Результат),"", ", ") + "Подразделение", "");
	Результат = Результат + ?(мРежимСложениеОбъединениеСУчетомПроектов = Истина, ?(ПустаяСтрока(Результат),"", ", ") + "Проект", "");
	Результат = Результат + ?(мРежимСложениеОбъединениеСУчетомКонтрагентов = Истина, ?(ПустаяСтрока(Результат),"", ", ") + "Контрагент", "");
	Результат = Результат + ?(мРежимСложениеОбъединениеСУчетомДоговоров = Истина, ?(ПустаяСтрока(Результат),"", ", ") + "Договор", "");
	
	Результат = ?(мРежимОбъединение = Истина, "Объединение", "Сложение") + ?(ПустаяСтрока(Результат), "", " (" + Результат + ")");
	
	РежимСложенияОбъединения = Результат;
	
КонецПроцедуры // УстановитьПредставлениеРежимСложенияОбъединения()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

Процедура ПриОткрытии()
	
	ИнициализацияПомощникаПланирования();
	
	Если мДокумент <> Неопределено Тогда
		
		КонечныеПланы.Очистить();
			
		НовыйКонечныйПлан = КонечныеПланы.Добавить();
			
		Если ТипЗнч(мДокумент) = Тип("ДокументОбъект.ПланЗакупок") Тогда
				
			НовыйКонечныйПлан.ВидПлана = Перечисления.ВидыПланирования.Закупки;
				
		ИначеЕсли ТипЗнч(мДокумент) = Тип("ДокументОбъект.ПланПродаж") Тогда
				
			НовыйКонечныйПлан.ВидПлана = Перечисления.ВидыПланирования.Продажи;
				
		КонецЕсли;
			
		НовыйКонечныйПлан.Сценарий = мДокумент.Сценарий;
		НовыйКонечныйПлан.ДатаНач = мДокумент.ДатаПланирования;
		НовыйКонечныйПлан.ДатаКон = мДокумент.ДатаПланирования;
		НовыйКонечныйПлан.Проект = мДокумент.Проект;
		НовыйКонечныйПлан.Подразделение = мДокумент.Подразделение;
			
		УправлениеПланированием.ВыровнятьДатуПоКонцуПериода(НовыйКонечныйПлан.ДатаКон, мДокумент.Сценарий.Периодичность);
		
		ЭлементыФормы.ТабличноеПолеКонечныеПланы.ИзменятьСоставСтрок = Ложь;
		ЭлементыФормы.ТабличноеПолеКонечныеПланы.ИзменятьПорядокСтрок = Ложь;
		
		Для каждого Колонка из ЭлементыФормы.ТабличноеПолеКонечныеПланы.Колонки Цикл
			
			Колонка.ТолькоПросмотр = Колонка.Имя <> "ПрофильРаспределения" И Колонка.Имя <> "ПрофильРаспределенияДетализацияПлана";
			
		КонецЦикла;
		
		ЭлементыФормы.Панель.Страницы.СформированныеДокументы.Видимость = Ложь;
		
		Заголовок = Заголовок + " (" + Строка(мДокумент) + ")";
		
		Если мДокумент.Метаданные().Реквизиты.Найти("НастройкиПомощникаПланирования") <> Неопределено Тогда
			
			НастройкиПомощникаПланирования = мДокумент.НастройкиПомощникаПланирования.Получить();
			
			Если ТипЗнч(НастройкиПомощникаПланирования) = Тип("Структура") Тогда
				
				ВосстановитьНастройкиИзСтруктуры(НастройкиПомощникаПланирования);
				мВосстановленыЗначения = Истина;
				
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		
		СтруктураНастройки = Новый Структура;
		СтруктураНастройки.Вставить("Пользователь", глЗначениеПеременной("глТекущийПользователь"));
		СтруктураНастройки.Вставить("ИмяОбъекта", Строка(ЭтотОбъект));
		
		Если УниверсальныеМеханизмы.ПолучитьНастройкуИспользоватьПриОткрытии(СтруктураНастройки) Тогда
			
			мТекущаяНастройка = СтруктураНастройки;
			ВосстановитьНастройкиИзСтруктуры(СтруктураНастройки.СохраненнаяНастройка);
			мВосстановленыЗначения = Истина;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Если мВосстановленыЗначения <> Истина Тогда
		
		УстановитьНачальныеЗначения();
		
		НастроитьПостроитель(ПостроительОтчета);
		
	КонецЕсли;
	
	УправлениеДоступностьюЭлементовУправления(ЭлементыФормы.ФлажокИзменитьРезультатРасчетаКоличества);
	УправлениеДоступностьюЭлементовУправления(ЭлементыФормы.ФлажокИзменитьРезультатРасчетаСуммы);
	
	ЭлементыФормы.КоманднаяПанельФормы.Кнопки.РежимВыбораДатПериодом.Пометка = РежимВыбораДатПериодом;
	ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Подменю.Кнопки.РежимВыбораДатПериодом.Пометка = РежимВыбораДатПериодом;
	
	РаботаСДиалогами.УстановитьВидимостьПроекта(, ЭлементыФормы, "ТабличноеПолеКонечныеПланы.Проект");
	
КонецПроцедуры // ПриОткрытии()

Процедура ОбновлениеОтображения()
	
	УстановитьПредставлениеРежимСложенияОбъединения();
	
КонецПроцедуры // ОбновлениеОтображения()

Процедура ПриЗакрытии()
	
	Если мДокумент <> Неопределено И мДокумент.Метаданные().Реквизиты.Найти("НастройкиПомощникаПланирования") <> Неопределено Тогда
				
		СтруктураСНастройками = Новый Структура;
		СформироватьСтруктуруДляСохраненияНастроек(СтруктураСНастройками);
		мДокумент.НастройкиПомощникаПланирования = Новый ХранилищеЗначения(СтруктураСНастройками, Новый СжатиеДанных(9));
		
	КонецЕсли;

КонецПроцедуры // ПриЗакрытии()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ДЛЯ УПРАВЛЕНИЯ ВНЕШНИМ ВИДОМ ФОРМЫ

Процедура УправлениеДоступностьюЭлементовУправления(Элемент)
	
	ИмяЭлемента = Элемент.Имя;
	
	ДоступностьЭлементов = Элемент.Значение;
	
	Если ИмяЭлемента = "ФлажокИзменитьРезультатРасчетаКоличества" Тогда
		
		ЭлементыФормы.ПолеВводаИзменитьРезультатРасчетаКоличестваПроцент.Доступность = ДоступностьЭлементов;
		
	ИначеЕсли ИмяЭлемента = "ФлажокИзменитьРезультатРасчетаСуммы" Тогда
		
		ЭлементыФормы.ПолеВводаИзменитьРезультатРасчетаСуммыПроцент.Доступность = ДоступностьЭлементов;
		
	КонецЕсли;
	
КонецПроцедуры // УправлениеДоступностьюЭлементовУправления()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ РЕКВИЗИТОВ ФОРМЫ

Процедура ФлажокПриИзменении(Элемент)
	
	УправлениеДоступностьюЭлементовУправления(Элемент);
	
КонецПроцедуры // ФлажокПриИзменении()

Процедура ПолеВыбораРезультатРасчетаКоличестваОкруглитьДоОчистка(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры // ПолеВыбораРезультатРасчетаКоличестваОкруглитьДоОчистка()

Процедура ПолеВыбораРезультатРасчетаСуммыОкруглитьДоОчистка(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры // ПолеВыбораРезультатРасчетаСуммыОкруглитьДоОчистка()

Процедура ФлажокИспользоватьСвойстваИКатегорииПриИзменении(Элемент)
	
	НастройкиПостроителя = ПостроительОтчета.ПолучитьНастройки(Истина, Ложь, Ложь, Ложь, Ложь);
	НастроитьПостроитель(ПостроительОтчета);
	ПостроительОтчета.УстановитьНастройки(НастройкиПостроителя, Истина, Ложь, Ложь, Ложь, Ложь);
	
КонецПроцедуры // ФлажокИспользоватьСвойстваИКатегорииПриИзменении()

Процедура ПолеВводаДатаНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	Если РежимВыбораДатПериодом Тогда
		
		СтандартнаяОбработка = Ложь;
	
		ТекущиеДанные = ТекущийЭлемент.ТекущиеДанные;
		
		мНастройкаПериода.УстановитьПериод(ТекущиеДанные.ДатаНач, ?(ТекущиеДанные.ДатаКон = Дата('00010101000000'), ТекущиеДанные.ДатаКон, КонецДня(ТекущиеДанные.ДатаКон)));
		
		Если мНастройкаПериода.Редактировать() Тогда
			
			ТекущиеДанные.ДатаНач = мНастройкаПериода.ПолучитьДатуНачала();
			ТекущиеДанные.ДатаКон = мНастройкаПериода.ПолучитьДатуОкончания();

		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ПолеВводаДатаНачалоВыбора()

Процедура ПолеВводаРежимСложенияОбъединенияНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	ФормаРежимСложенияОбъединения = ОбработкаОбъект.ПолучитьФорму("ФормаРежимСложенияОбъединения", ЭтаФорма);
	ФормаРежимСложенияОбъединения.ОткрытьМодально();
	
КонецПроцедуры // ПолеВводаРежимСложенияОбъединенияНачалоВыбора()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНОЙ ПАНЕЛИ "КоманднаяПанельФормы"

Процедура КоманднаяПанельФормыВосстановитьНастройку(Кнопка)
	
	ВосстановитьНастройки();
	
КонецПроцедуры // КоманднаяПанельФормыВосстановитьНастройку()

Процедура КоманднаяПанельФормыСохранитьНастройку(Кнопка)
	
	СохранитьНастройки(ПостроительОтчета);
	
КонецПроцедуры // КоманднаяПанельФормыСохранитьНастройку()

Процедура КоманднаяПанельФормыВыбиратьДатыПериодом(Кнопка)
	
	РежимВыбораДатПериодом = НЕ РежимВыбораДатПериодом;
	ЭлементыФормы.КоманднаяПанельФормы.Кнопки.РежимВыбораДатПериодом.Пометка = РежимВыбораДатПериодом;
	ЭлементыФормы.КоманднаяПанельФормы.Кнопки.Подменю.Кнопки.РежимВыбораДатПериодом.Пометка = РежимВыбораДатПериодом;
	
КонецПроцедуры // КоманднаяПанельФормыВыбиратьДатыПериодом()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНОЙ ПАНЕЛИ "ОсновныеДействияФормы"

Процедура ОсновныеДействияФормыДалее(Кнопка)
	
	Страницы = ЭлементыФормы.Панель.Страницы;
	Индекс = Страницы.Индекс(ЭлементыФормы.Панель.ТекущаяСтраница);
	
	Пока Истина Цикл
		
		Индекс = Индекс + 1;
		
		Если Индекс >= Страницы.Количество() Тогда
			
			Индекс = -1;
			
		ИначеЕсли Страницы.Получить(Индекс).Видимость = Ложь Тогда
			
			Продолжить;
			
		Иначе
			
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ЭлементыФормы.Панель.ТекущаяСтраница = Страницы.Получить(Индекс);
	
КонецПроцедуры // ОсновныеДействияФормыДалее()

Процедура КнопкаВыполнитьНажатие(Элемент)
	
	УстановитьЭкспортныеПеременные();
	
	Если НЕ УстановитьПараметрыПостроителя(ПостроительОтчета) Тогда
		
		Возврат;
		
	КонецЕсли;
	
	// Проверка корректности заполнения исходных данных
	Если НЕ КорректностьЗаполненияДокумента() ИЛИ НЕ КорректностьЗаполненияДанных() Тогда
		
		Предупреждение("Обнаружены ошибки заполнения исходных данных!");
		Возврат;
		
	КонецЕсли;
	
	ПостроительОтчета.Выполнить();
	
	Если ПостроительОтчета.Результат.Пустой() Тогда
		
		Предупреждение("По указанным стратегиям расчета данные не выбраны!");
		Возврат;
		
	КонецЕсли;
	
	Результат = ПостроительОтчета.Результат.Выгрузить(ОбходРезультатаЗапроса.Прямой);
		
	Если ВыполнитьОбработку(Результат) Тогда
		
		Если мДокумент <> Неопределено Тогда
		
			Предупреждение("Заполнение документа завершено.");
			
		Иначе
			
			ЭлементыФормы.Панель.ТекущаяСтраница = ЭлементыФормы.Панель.Страницы["СформированныеДокументы"];
			Предупреждение("Формирование документов завершено.");
			
		КонецЕсли;
		
	Иначе
		
		Если мДокумент <> Неопределено Тогда
		
			Предупреждение("Данные, выбранные по указанным стратегиям, не соответствуют заполняемому документу." + Символы.ПС + "Заполнение документа не выполнено!");
			
		Иначе
			
			Предупреждение("Данные, выбранные по указанным стратегиям, не соответствуют формируемым документам." + Символы.ПС + "Формирование документов не выполнено!");
			
		КонецЕсли;

	КонецЕсли;
	
КонецПроцедуры // КнопкаВыполнитьНажатие()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОГО ПОЛЯ "ТабличноеПолеСтратегииРасчетаКоличества"

Процедура ТабличноеПолеСтратегииРасчетаКоличестваПередНачаломДобавления(Элемент, Отказ, Копирование)
	
	Если Копирование Тогда
		
	Иначе
		
		СписокСтратегий = Новый СписокЗначений;
		
		Для каждого Стратегия из мМассивСтратегии Цикл
			
			СписокСтратегий.Добавить(Стратегия.ВидСтратегии, Стратегия.Представление);
			
		КонецЦикла;

		ВыбраннаяСтратегия = СписокСтратегий.ВыбратьЭлемент("Выбор типа стратегии");
		
		Если ВыбраннаяСтратегия = Неопределено Тогда
			
			Отказ = Истина;
			
		Иначе
			
			мВыбраннаяСтратегия = ВыбраннаяСтратегия;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаКоличестваПередНачаломДобавления()

Процедура ТабличноеПолеСтратегииРасчетаКоличестваПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		
		Если Копирование Тогда
			
			УстановитьИдентификаторСтроки(Элемент.ТекущиеДанные, СтратегииРасчета.ВыгрузитьКолонку("ИдентификаторСтроки"));
			
			Если Элемент.ТекущиеДанные.Использование Тогда
				
				НастройкиПостроителя = ПостроительОтчета.ПолучитьНастройки(Истина, Ложь, Ложь, Ложь, Ложь);
				НастроитьПостроитель(ПостроительОтчета);
				ПостроительОтчета.УстановитьНастройки(НастройкиПостроителя, Истина, Ложь, Ложь, Ложь, Ложь);
				
			КонецЕсли;
			
		Иначе
			
			Элемент.ТекущиеДанные.ВидСтратегии = мВыбраннаяСтратегия.Значение;
			Элемент.ТекущиеДанные.НаименованиеСтратегии = мВыбраннаяСтратегия.Представление;
			Элемент.ТекущиеДанные.Процент = 100;
			УстановитьИдентификаторСтроки(Элемент.ТекущиеДанные, СтратегииРасчета.ВыгрузитьКолонку("ИдентификаторСтроки"));
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаКоличестваПриНачалеРедактирования()

Процедура ТабличноеПолеСтратегииРасчетаКоличестваПослеУдаления(Элемент)
	
	НастройкиПостроителя = ПостроительОтчета.ПолучитьНастройки(Истина, Ложь, Ложь, Ложь, Ложь);
	НастроитьПостроитель(ПостроительОтчета);
	ПостроительОтчета.УстановитьНастройки(НастройкиПостроителя, Истина, Ложь, Ложь, Ложь, Ложь);
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаКоличестваПослеУдаления()

Процедура ТабличноеПолеСтратегииРасчетаКоличестваПриПолученииДанных(Элемент, ОформленияСтрок)
	
	Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
		
		ДанныеСтроки = ОформлениеСтроки.ДанныеСтроки;
		
		Если ДанныеСтроки.ВидСтратегии <> "" Тогда
			
			ОформлениеСтроки.Ячейки.ВидСтратегии.УстановитьТекст(ПолучитьПараметрыСтратегииПоВиду(ДанныеСтроки.ВидСтратегии).Представление);
			
			Если ПолучитьПараметрыСтратегииПоВиду(ДанныеСтроки.ВидСтратегии).НаДату Тогда
					
				ОформлениеСтроки.Ячейки.НаДату.Видимость = Истина;
				ОформлениеСтроки.Ячейки.ДатаНач.Видимость = Ложь;
				ОформлениеСтроки.Ячейки.ДатаКон.Видимость = Ложь;
					
			Иначе
					
				ОформлениеСтроки.Ячейки.НаДату.Видимость = Ложь;
				ОформлениеСтроки.Ячейки.ДатаНач.Видимость = Истина;
				ОформлениеСтроки.Ячейки.ДатаКон.Видимость = Истина;
					
			КонецЕсли;
			
		КонецЕсли;
				
	КонецЦикла;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаКоличестваПриПолученииДанных()

Процедура ТабличноеПолеСтратегииРасчетаКоличестваПриИзмененииФлажка(Элемент, Колонка)
	
	Если Колонка.Имя = "Использование" Тогда
		
		НастройкиПостроителя = ПостроительОтчета.ПолучитьНастройки(Истина, Ложь, Ложь, Ложь, Ложь);
		НастроитьПостроитель(ПостроительОтчета);
		ПостроительОтчета.УстановитьНастройки(НастройкиПостроителя, Истина, Ложь, Ложь, Ложь, Ложь);
		
	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаКоличестваПриИзмененииФлажка()

Процедура ТабличноеПолеСтратегииРасчетаКоличестваНаименованиеПриИзменении(Элемент)
	
	ТекущиеДанные = ЭлементыФормы.ТабличноеПолеСтратегииРасчетаКоличества.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено И ТекущиеДанные.Использование Тогда
		
		УстановитьПредставленияПолей(ПостроительОтчета, Истина);
		
	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаКоличестваНаименованиеПриИзменении()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОГО ПОЛЯ "ТабличноеПолеСтратегииРасчетаСуммы"

Процедура ТабличноеПолеСтратегииРасчетаСуммыПриПолученииДанных(Элемент, ОформленияСтрок)
	
	Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
		
		ОформлениеСтроки.Ячейки.СтратегияРасчетаСуммы.УстановитьТекст(Элемент.Колонки.СтратегияРасчетаСуммы.ЭлементУправления.СписокВыбора.НайтиПоЗначению(ОформлениеСтроки.ДанныеСтроки.СтратегияРасчетаСуммы).Представление);
		ОформлениеСтроки.Ячейки.Функция.УстановитьТекст(Элемент.Колонки.Функция.ЭлементУправления.СписокВыбора.НайтиПоЗначению(ОформлениеСтроки.ДанныеСтроки.Функция).Представление);
		
		Если ОформлениеСтроки.ДанныеСтроки.ТипЦен = Неопределено ИЛИ ОформлениеСтроки.ДанныеСтроки.ТипЦен.Пустая() Тогда
			
			ОформлениеСтроки.Ячейки.ТипЦен.ОтображатьКартинку = Ложь;
			ОформлениеСтроки.Ячейки.ТипЦен.Картинка = Новый Картинка;
			ОформлениеСтроки.Ячейки.ТипЦен.ТолькоПросмотр = Истина;
			
		ИначеЕсли ТипЗнч(ОформлениеСтроки.ДанныеСтроки.ТипЦен) = Тип("СправочникСсылка.ТипыЦенНоменклатуры") Тогда
			
			ОформлениеСтроки.Ячейки.ТипЦен.ОтображатьКартинку = Истина;
			ОформлениеСтроки.Ячейки.ТипЦен.Картинка = БиблиотекаКартинок.СправочникНоменклатура;
			ОформлениеСтроки.Ячейки.ТипЦен.ТолькоПросмотр = Ложь;
			
		ИначеЕсли ТипЗнч(ОформлениеСтроки.ДанныеСтроки.ТипЦен) = Тип("СправочникСсылка.ТипыЦенНоменклатурыКонтрагентов") Тогда
			
			ОформлениеСтроки.Ячейки.ТипЦен.ОтображатьКартинку = Истина;
			ОформлениеСтроки.Ячейки.ТипЦен.Картинка = БиблиотекаКартинок.СправочникКонтрагенты;
			ОформлениеСтроки.Ячейки.ТипЦен.ТолькоПросмотр = Ложь;
			
		КонецЕсли;
		
		ОформлениеСтроки.Ячейки.ТипЦен.ТолькоПросмотр = ОформлениеСтроки.ДанныеСтроки.СтратегияРасчетаСуммы = 0;
		
	КонецЦикла;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаСуммыПриПолученииДанных()

Процедура ТабличноеПолеСтратегииРасчетаСуммыПриИзмененииФлажка(Элемент, Колонка)
	
	Если Колонка.Имя = "Использование" Тогда
		
		НастройкиПостроителя = ПостроительОтчета.ПолучитьНастройки(Истина, Ложь, Ложь, Ложь, Ложь);
		НастроитьПостроитель(ПостроительОтчета);
		ПостроительОтчета.УстановитьНастройки(НастройкиПостроителя, Истина, Ложь, Ложь, Ложь, Ложь);
		
	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаСуммыПриИзмененииФлажка()

Процедура ТабличноеПолеСтратегииРасчетаСуммыСтратегияРасчетаСуммыПриИзменении(Элемент)
	
	СтратегияРасчетаСуммы = Элемент.Значение;
	
	Если СтратегияРасчетаСуммы = 0 Тогда
		
		ОписаниеТипов = Новый ОписаниеТипов("СправочникСсылка.ТипыЦенНоменклатуры");
		ЭлементыФормы.ТабличноеПолеСтратегииРасчетаСуммы.ТекущиеДанные.ТипЦен = ОписаниеТипов.ПривестиЗначение();
		
	ИначеЕсли СтратегияРасчетаСуммы = 1 Тогда
		
		ОписаниеТипов = Новый ОписаниеТипов("СправочникСсылка.ТипыЦенНоменклатуры");
		ЭлементыФормы.ТабличноеПолеСтратегииРасчетаСуммы.ТекущиеДанные.ТипЦен = ОписаниеТипов.ПривестиЗначение(ЭлементыФормы.ТабличноеПолеСтратегииРасчетаСуммы.ТекущиеДанные.ТипЦен);
		
	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеСтратегииРасчетаСуммыСтратегияРасчетаСуммыПриИзменении()

Процедура ТабличноеПолеСтратегииРасчетаСуммыТипЦенНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	Если ЭлементыФормы.ТабличноеПолеСтратегииРасчетаСуммы.ТекущиеДанные.СтратегияРасчетаСуммы = 2 Тогда
		
		СтандартнаяОбработка = Ложь;
		
		СписокВыбора = Новый СписокЗначений;
		СписокВыбора.Добавить("ТипыЦенНоменклатурыКонтрагентов", "Номенклатуры контрагентов");
		СписокВыбора.Добавить("ТипыЦенНоменклатуры", "Номенклатуры");

		ВыбранныйЭлемент = ВыбратьИзСписка(СписокВыбора, Элемент);

		Если ВыбранныйЭлемент = Неопределено Тогда
			
			Возврат;
			
		КонецЕсли;
		
		ФормаВыбора = Справочники[ВыбранныйЭлемент.Значение].ПолучитьФормуВыбора(, Элемент);
		ФормаВыбора.Открыть();
		
	КонецЕсли;

КонецПроцедуры // ТабличноеПолеСтратегииРасчетаСуммыТипЦенНачалоВыбора()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОГО ПОЛЯ "ТабличноеПолеОтбор"

Процедура ТабличноеПолеОтборЗначениеНачалоВыбора(Элемент, СтандартнаяОбработка)
	
	// Отборы по свойствам должны быть обработаны специальным образом
	// Они определяются по представлению 
	Если Найти(ЭлементыФормы.ТабличноеПолеОтбор.ТекущаяСтрока.Представление, "св-во") Тогда

		Для каждого Назначение из мСоответствиеНазначений Цикл
			
			Если Найти(ЭлементыФормы.ТабличноеПолеОтбор.ТекущаяСтрока.Представление, Назначение.Ключ) > 0 Тогда
				
				Свойство = Назначение.Значение;
				Прервать;
				
			КонецЕсли;
			
		КонецЦикла;
		
		УправлениеОтчетами.ОсуществитьВыборСвойства(Элемент, Свойство, ЭтаФорма, СтандартнаяОбработка);

	КонецЕсли;
	
КонецПроцедуры // ТабличноеПолеОтборЗначениеНачалоВыбора()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНОЙ ПАНЕЛИ "КоманднаяПанельСформированныеДокументы"

Процедура КоманднаяПанельСформированныеДокументыУстановитьПометки(Кнопка)
	
	ОбновитьСостоянияДокументов();
	
	Для каждого Строка из СформированныеДокументы Цикл
		
		Строка.Пометка = Истина;
		
	КонецЦикла;
	
КонецПроцедуры // КоманднаяПанельСформированныеДокументыУстановитьПометки()

Процедура КоманднаяПанельСформированныеДокументыСнятьПометки(Кнопка)
	
	ОбновитьСостоянияДокументов();
	
	Для каждого Строка из СформированныеДокументы Цикл
		
		Строка.Пометка = Ложь;
		
	КонецЦикла;
	
КонецПроцедуры // КоманднаяПанельСформированныеДокументыСнятьПометки()

Процедура КоманднаяПанельСформированныеДокументыПровести(Кнопка)
	
	ОбновитьСостоянияДокументов();
	
	Для каждого Строка из СформированныеДокументы Цикл
		
		Если Строка.Пометка Тогда
			
			ДокументОбъект = Строка.Документ.ПолучитьОбъект();
			
			Если ДокументОбъект <> Неопределено И НЕ ДокументОбъект.ПометкаУдаления Тогда
				
				Попытка
					
					Строка.Документ.ПолучитьОбъект().Записать(РежимЗаписиДокумента.Проведение);
					Строка.Пометка = Ложь;
					
				Исключение
				КонецПопытки;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ОбновитьСостоянияДокументов();
	
КонецПроцедуры // КоманднаяПанельСформированныеДокументыПровести()

Процедура КоманднаяПанельСформированныеДокументыПометитьНаУдаление(Кнопка)
	
	ОбновитьСостоянияДокументов();
	
	Для каждого Строка из СформированныеДокументы Цикл
		
		Если Строка.Пометка Тогда
			
			Если Строка.Документ.ПолучитьОбъект() <> Неопределено Тогда
				
				Строка.Документ.ПолучитьОбъект().УстановитьПометкуУдаления(НЕ Строка.ПометкаУдаления);
				Строка.Пометка = Ложь;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ОбновитьСостоянияДокументов();
	
КонецПроцедуры // КоманднаяПанельСформированныеДокументыПечать()

Процедура КоманднаяПанельСформированныеДокументыУдалить(Кнопка)
	
	КодВозврата = Вопрос("Внимание! Выбранные документы будут удалены без возможности восстановления
	|и без проверки ссылочной целостности!", РежимДиалогаВопрос.ОКОтмена,,, "Помощник планирования");
	
	Если КодВозврата <> КодВозвратаДиалога.ОК Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ОбновитьСостоянияДокументов();
	
	Для каждого Строка из СформированныеДокументы Цикл
		
		Если Строка.Пометка Тогда
			
			Если Строка.Документ.ПолучитьОбъект() <> Неопределено Тогда
				
				Строка.Документ.ПолучитьОбъект().Удалить();
				Строка.Пометка = Ложь;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ОбновитьСостоянияДокументов();
	
КонецПроцедуры // КоманднаяПанельСформированныеДокументыУдалить()

Процедура КоманднаяПанельСформированныеДокументыПечать(Кнопка)
	
	ОбновитьСостоянияДокументов();
	
	Для каждого Строка из СформированныеДокументы Цикл
		
		Если Строка.Пометка Тогда
			
			ДокументОбъект = Строка.Документ.ПолучитьОбъект();
			
			Если ДокументОбъект <> Неопределено Тогда
				
				Попытка
					
					ДокументОбъект.Печать(ДокументОбъект.Метаданные().Имя);
					
				Исключение
					
					ОбщегоНазначения.СообщитьОбОшибке(ОписаниеОшибки(),, (Строка(ДокументОбъект) + ", печать не выполнена"));
					
				КонецПопытки;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // КоманднаяПанельСформированныеДокументыПечать()

Процедура КоманднаяПанельСформированныеДокументыОбновить(Кнопка)
	
	ОбновитьСостоянияДокументов();

КонецПроцедуры // КоманднаяПанельСформированныеДокументыОбновить()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЧНОГО ПОЛЯ "ТабличноеПолеСформированныеДокументы"

Процедура ТабличноеПолеСформированныеДокументыВыбор(Элемент, ВыбраннаяСтрока, Колонка, СтандартнаяОбработка)
	
	ОбновитьСостоянияДокументов();
	
	Попытка
		
		ОткрытьЗначение(ВыбраннаяСтрока.Документ);
		
	Исключение
	КонецПопытки;

КонецПроцедуры // ТабличноеПолеСформированныеДокументыВыбор()

Процедура ТабличноеПолеСформированныеДокументыПриПолученииДанных(Элемент, ОформленияСтрок)
	
	Для каждого ОформлениеСтроки из ОформленияСтрок Цикл
		
		ОформлениеСтроки.Ячейки.Проведен.ОтображатьТекст = Ложь;
		ОформлениеСтроки.Ячейки.Проведен.ОтображатьФлажок = Ложь;
		ОформлениеСтроки.Ячейки.Проведен.ОтображатьКартинку = Истина;
		
		Если ОформлениеСтроки.ДанныеСтроки.ПометкаУдаления Тогда
			
			ОформлениеСтроки.Ячейки.Проведен.ИндексКартинки = 1;
			
		ИначеЕсли ОформлениеСтроки.ДанныеСтроки.ДокументПроведен Тогда
			
			ОформлениеСтроки.Ячейки.Проведен.ИндексКартинки = 0;
			
		Иначе
			
			ОформлениеСтроки.Ячейки.Проведен.ИндексКартинки = 2;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры // ТабличноеПолеСформированныеДокументыПриПолученииДанных()

мНастройкаПериода = Новый НастройкаПериода;
мНастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
